<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="icons/favicon.ico" type="image/x-icon" />

    <title>Metro4all</title>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap-3.0.0/dist/css/bootstrap.css" rel="stylesheet">

    <!-- Select2 plugin -->
    <link href="select2-3.4.2/select2.css" rel="stylesheet"/>

    <!-- Leaflet -->
    <link href="leaflet-0.6.4/leaflet.css" rel="stylesheet"/>
    <!--[if lte IE 8]>
      <link href="leaflet-0.6.4/leaflet.ie.css" rel="stylesheet"/>
    <![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="../../assets/js/html5shiv.js"></script>
      <script src="../../assets/js/respond.min.js"></script>
    <![endif]-->

  </head>

  <body>

    <div class="container">
    <div class="row">

      <!-- Left panel -->
      <div class="col-md-3">
      <form id="mainform" role="form">
        <legend>Откуда</legend>
        <div class="form-group">
          <label for="metroStartStation">Станция:</label>
          <div>
            <input id="metroStartStation" name="station_from" type="hidden">
          </div>
        </div>
        <div class="form-group">
          <label for="metroStartInputID">Вход:</label>
          <input name="portal_from" class="form-control" id="metroStartInputID" type="text" placeholder="Выберите вход на карте..." readonly>
          <div id="metroStartInput" style="height: 150px;"></div>
          <em>Нажмите на значок входа, чтобы его выбрать</em>
        </div>
        <legend>Куда</legend>
        <div class="form-group">
          <label for="metroEndStation">Станция:</label>
          <div>
            <input id="metroEndStation" name="station_to" type="hidden">
          </div>
        </div>
        <div class="form-group">
          <label for="metroEndInputID">Выход:</label>
          <input name="portal_to" class="form-control" id="metroEndInputID" type="text" placeholder="Выберите выход на карте..." readonly>
          <div id="metroEndInput" style="height: 150px;"></div>
          <em>Нажмите на значок выхода, чтобы его выбрать</em>
        </div>
        <button type="submit" class="btn btn-primary">Поиск</button>
      </form>
      </div>

      <div id="map" class="col-md-6">
          <legend>Карта</legend>
          <div id="mainMap" style="height: 480px;"></div>
      </div>

      <!-- Right panel -->
      <div class="col-md-3">
        <legend>Маршрут</legend>
        <div style="float:left; width:185px;">Aльтернативные маршруты:</div>
        <ul class="pagination pagination-sm" style="margin: 0 0"></ul>
        <div id="routePanel"></div>
      </div>
    </div>
    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="bootstrap-3.0.0/assets/js/jquery.js"></script>
    <script src="bootstrap-3.0.0/dist/js/bootstrap.min.js"></script>
    <script src="select2-3.4.2/select2.js"></script>
    <script src="select2-3.4.2/select2_locale_ru.js"></script>
    <script src="leaflet-0.6.4/leaflet.js"></script>
    <script src="TileLayer.Grayscale.js"></script>
    <script src="m4a/m4a.url.js"></script>
    <script>
        var stationsLookup = [
            {},
            {'name': 'Сокольническая', 'color': '#ED1B35'},
            {'name': 'Замоскворецкая', 'color': '#44B85C'},
            {'name': 'Арбатско-Покровская', 'color': '#0078BF'},
            {'name': 'Филёвская', 'color': '#19C1F3'},
            {'name': 'Кольцевая', 'color': '#894E35'},
            {'name': 'Калужско-Рижская', 'color': '#F58631'},
            {'name': 'Таганско-Краснопресненская', 'color': '#8E479C'},
            {'name': 'Калининская', 'color': '#FFCB31'},
            {'name': 'Серпуховско-Тимирязевская', 'color': '#A1A2A3'},
            {'name': 'Люблинская', 'color': '#B3D445'},
            {'name': 'Каховская', 'color': '#79CDCD'},
            {'name': 'Бутовская', 'color': '#ACBFE1'}];

        function fillBarriers(content, barriers) {
            content+="<ul>";
            content+="<li><strong>Ширина коляски</strong>: " + "до " + barriers['min_width'] + " см" + "</li>";
            content+="<li><strong>Ступенек</strong>: " + barriers['min_step'] + "</li>";
            content+="<li><strong>Из них без рельс и рамп</strong>: " + (barriers['min_step'] - barriers['min_step_ramp']) + "</li>";
            content+="<li><strong>Лифт</strong>: " + {true: 'есть', false: 'нет'}[barriers['lift']];

            // Лифт
            if (barriers['lift']) {
                content+=", экономит " + barriers['lift_minus_step'] + " ступенек";
            }
            content+="</li>";

            // Аппарели
            content+="<li><strong>Мин-макс. расстояние между колесами</strong>: "
            if ((barriers['min_rail_width']) && (barriers['max_rail_width'])) {
                content+=barriers['min_rail_width'] + " &ndash; " + barriers['max_rail_width'] + " см";
            } else {
                content+="аппарели отсутствуют";
            }
            content+="</li>";

            // Наклонные поверхности
            content+="<li><strong>Угол наклона</strong>: "
            if (barriers['max_angle']) {
                content+=barriers['max_angle'] + "&deg;";
            } else {
                content+="наклонных поверхностей нет";
            }
            content+="</li>";
            content+="</ul>";
            return content;
        }

        function showRoute(routes, index) {
            
            // Вывод списка станций, входящих в маршрут
            $.each(routes[index], function(i, item){
                var content = "<h4>"+(i+1)+". "+item.station_name+"</h4>";
                if ((item.station_type == 'start') || (item.station_type == 'end')) {
                    if (item.barriers) {
                        content = fillBarriers(content, item.barriers);
                    } else {
                        content+="<em>" + "Препятствия не отображаются, так как не выбран " + {'start': 'вход', 'end': 'выход'}[item.station_type] + "</em>";
                    }
                } else if (item.station_type == 'interchange') {
                    if (item.barriers) {
                        content = fillBarriers(content, item.barriers);
                    }
                }

                $('#routePanel').append(
                "<div>" + content + "</div>"
                );
            });
            
            // Отображение маршрута на карте
            if (typeof route !== 'undefined') {
                mainMap.removeLayer(route);
            }
            route = L.layerGroup()
            $.each(routes[index], function(i, item){
                if (i != 0) {
                    route.addLayer(
                        L.polyline(
                            [routes[index][i-1].coordinates, item.coordinates],
                            {
                                color: stationsLookup[item.station_line].color,
                                opacity: 1
                            })
                    ).addTo(mainMap);
                }
            });

        }

        $(document).ready(function() {
          m4a.url.init();
          mainMap = L.map('mainMap').setView([55.75, 37.62], 10);
          var url = "/",
              metroStartInputMap = L.map('metroStartInput', {zoomControl:false, attributionControl: false}).setView([55.75, 37.62], 11),
              metroEndInputMap = L.map('metroEndInput', {zoomControl:false, attributionControl: false}).setView([55.75, 37.62], 11);

          // Заполнение выпадающих списков
          $.ajax("/stations").done(function(data){$("#metroStartStation").select2({width: "100%", data: data})});
          $.ajax("/stations").done(function(data){$("#metroEndStation").select2({width: "100%", data: data})});
          
          // Поле выбора станции входа
          $("#metroStartStation").on("change", function(e) {
            $("#metroStartInputID").val("");
            m4a.view.$document.triggerHandler('/url/update', ['start', '']);
            m4a.view.$document.triggerHandler('/url/update', ['stat-start', e.val]);
            $.ajax({
              dataType: "json",
              url: url + "portals/search",
              data: {
                station: e.val,
                direction: "in"
              },
            }).done(function(data) {
                // Очищаем слой входов
                if (typeof inPortals !== 'undefined') {
                    metroStartInputMap.removeLayer(inPortals);
                }
                if (data.features.length != 0) {

                    // Добавляем входы на карту
                    inPortals = L.geoJson(
                        data, {
                            pointToLayer: function(feature, latlng) {
                                return L.marker(
                                    latlng, {
                                        icon: L.icon({
                                            iconUrl: 'icons/in.png',
                                        })
                                    }
                                )
                            },
                            onEachFeature: function(feature, layer) {
                                layer.on('click', function (e) {
                                    $("#metroStartInputID").val(feature.id);
                                    m4a.view.$document.triggerHandler('/url/update', ['start', feature.id]);
                                });
                            }
                        }
                    ).addTo(metroStartInputMap);

                    // Устанавливаем новый охват
                    metroStartInputMap.fitBounds(inPortals.getBounds(), {padding: [0, 10]});
                }
            });
          });
          

          // Поле выбора станции выхода
          $("#metroEndStation").on("change", function(e) {
            $("#metroEndInputID").val("");
            m4a.view.$document.triggerHandler('/url/update', ['end', '']);
            m4a.view.$document.triggerHandler('/url/update', ['stat-end', e.val]);
            $.ajax({
              dataType: "json",
              url: url + "portals/search",
              data: {
                station: e.val,
                direction: "out"
              },
            }).done(function(data) {
                // Очищаем слой выходов
                if (typeof outPortals !== 'undefined') {
                    metroEndInputMap.removeLayer(outPortals);
                }
                if (data.features.length != 0) {

                    // Добавляем выходы на карту
                    outPortals = L.geoJson(
                        data, {
                            pointToLayer: function(feature, latlng) {
                                return L.marker(
                                    latlng, {
                                        icon: L.icon({
                                            iconUrl: 'icons/out.png',
                                        })
                                    }
                                )
                            },
                            onEachFeature: function(feature, layer) {
                                layer.on('click', function (e) {
                                    $("#metroEndInputID").val(feature.id);
                                    m4a.view.$document.triggerHandler('/url/update', ['end', feature.id]);
                                });
                            }
                        }
                    ).addTo(metroEndInputMap);

                    // Устанавливаем новый охват
                    metroEndInputMap.fitBounds(outPortals.getBounds(), {padding: [0, 10]});
                }
            });
          });

          // Карта для выбора входов
          L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: "Map data &copy; <a href='http://osm.org'>OpenStreetMap</a> contributors",
              maxZoom: 18
          }).addTo(metroStartInputMap);

          // Карта для выбора выходов
          L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: "Map data &copy; <a href='http://osm.org'>OpenStreetMap</a> contributors",
              maxZoom: 18
          }).addTo(metroEndInputMap);

          // Карта для отображения маршрутов
          L.tileLayer.grayscale('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: "Map data &copy; <a href='http://osm.org'>OpenStreetMap</a> contributors",
              maxZoom: 18
          }).addTo(mainMap);

          $("#mainform").submit(function() {
              if ($('#metroStartStation').val().length == 0 || $('#metroEndStation').val().length == 0) {
                // todo: use bootstrap
                alert('Не выбрана входная или выходная станция!');
              } else if ($('#metroStartStation').val() == $('#metroEndStation').val()) {
                alert('Выбраны одинаковые станции!');
              } else {
                  $('.pagination').empty();
                  $('#routePanel').empty();
                  $.ajax({
                      dataType: "json",
                      url: url + "routes/search",
                      data: $("#mainform").serialize()
                  }).done(function(data) {
                    
                    // Кнопки переключения маршрутов
                    $.each(data.routes, function(i, item){
                        $('.pagination').append('<li><a href="javascript:void(0)">'+(i+1)+'</a></li>');
                    });

                    // Обработчики нажатия кнопок
                    $('.pagination li').click(function(e) {
                        var route_index = parseInt($(this).text()) - 1;
                        $('.pagination li').addClass('active').not(this).removeClass('active');
                        $('#routePanel').empty();
                        showRoute(data.routes, route_index);
                        m4a.view.$document.triggerHandler('/url/update', ['route',route_index + 1]);
                    });

                    // Активируем первый маршрут
                    $('.pagination li').first().trigger('click');

                  });
              }
              return false;
          });

        });
    </script>
  </body>
</html>
